<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Update Password - My Student Club</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="https://www.mystudentclub.com/assets/icon-70x70.png">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
    }

    .update-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f9fafb;
      padding: 1rem;
    }

    .update-card {
      width: 100%;
      max-width: 420px;
      background: white;
      padding: 2.5rem;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    .update-title {
      font-size: 1.75rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      font-weight: 500;
      margin-bottom: 0.5rem;
      color: #4b5563;
    }

    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .update-btn {
      width: 100%;
      padding: 0.875rem;
      background: #4f46e5;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .update-btn:hover {
      background-color: #4338ca;
    }

    .update-btn:disabled {
      background-color: #a5b4fc;
      cursor: not-allowed;
    }

    .message {
      padding: 1rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      font-size: 0.9rem;
      display: none;
    }

    .message.success {
      background-color: #dcfce7;
      color: #166534;
    }

    .message.error {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .loader {
      display: none;
      text-align: center;
      color: #6b7280;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
  </style>
</head>

<body>
  <div class="update-page">
    <div class="update-card">
      <h1 class="update-title">Set a New Password</h1>

      <div id="loader" class="loader">Verifying link...</div>
      <div id="message" class="message"></div>

      <form id="update-password-form" style="display:none;">
        <div class="form-group">
          <label for="new-password" class="form-label">New Password</label>
          <input type="password" id="new-password" class="form-input" required minlength="6"
            autocomplete="new-password">
        </div>
        <div class="form-group">
          <label for="confirm-new-password" class="form-label">Confirm New Password</label>
          <input type="password" id="confirm-new-password" class="form-input" required minlength="6"
            autocomplete="new-password">
        </div>
        <button type="submit" id="update-btn" class="update-btn">Update Password</button>
      </form>
      <p class="text-center text-sm text-gray-500 mt-4"><a href="/login.html"
          class="text-indigo-600 hover:text-indigo-500">Back to Login</a></p>
    </div>
  </div>

  <script>
    // Initialize Supabase with the Proxy URL ONLY. 
    // Removed the customFetch fallback as it breaks functionality for firewall users.
    const supabaseClient = supabase.createClient(
      'https://api.mystudentclub.com',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6c2dnZHRkaWFjeGRzampuY2RxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1OTEzNjUsImV4cCI6MjA1NDE2NzM2NX0.FVKBJG-TmXiiYzBDjGIRBM2zg-DYxzNP--WM6q2UMt0'
    );

    const updatePasswordForm = document.getElementById('update-password-form');
    const newPasswordInput = document.getElementById('new-password');
    const confirmPasswordInput = document.getElementById('confirm-new-password');
    const updateBtn = document.getElementById('update-btn');
    const messageDiv = document.getElementById('message');
    const loaderDiv = document.getElementById('loader');

    // 1. Handle Automatic Code Exchange
    // We wait for the session to be established before showing the form.
    async function init() {
      loaderDiv.style.display = 'block';

      // Check if we already have a session (handled automatically by Supabase)
      const { data: { session } } = await supabaseClient.auth.getSession();

      if (session) {
        // User is authenticated, show form
        loaderDiv.style.display = 'none';
        updatePasswordForm.style.display = 'block';
      } else {
        // If no session, wait for the event (PKCE flow)
        supabaseClient.auth.onAuthStateChange(async (event, session) => {
          if (event === "PASSWORD_RECOVERY" || event === "SIGNED_IN") {
            loaderDiv.style.display = 'none';
            updatePasswordForm.style.display = 'block';
          }
        });

        // Fallback: If URL has a 'code' or 'error', handle display after a short timeout
        setTimeout(() => {
          const params = new URLSearchParams(window.location.search);
          const hashParams = new URLSearchParams(window.location.hash.substring(1));

          if (params.get('error') || hashParams.get('error')) {
            loaderDiv.style.display = 'none';
            showMessage('Invalid or expired link. Please request a new one.', 'error');
          } else if (!session && updatePasswordForm.style.display === 'none') {
            // Still waiting? Sometimes the event fires late.
          }
        }, 2000);
      }
    }

    init();

    updatePasswordForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const newPassword = newPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;
      showMessage('', 'none');

      updateBtn.disabled = true;
      updateBtn.textContent = 'Updating...';

      if (newPassword.length < 6) {
        showMessage('Password must be at least 6 characters long.', 'error');
        updateBtn.disabled = false;
        updateBtn.textContent = 'Update Password';
        return;
      }

      if (newPassword !== confirmPassword) {
        showMessage('Passwords do not match.', 'error');
        updateBtn.disabled = false;
        updateBtn.textContent = 'Update Password';
        return;
      }

      try {
        const { error } = await supabaseClient.auth.updateUser({
          password: newPassword
        });

        if (error) throw error;

        showMessage('Password updated successfully! Redirecting you to login...', 'success');
        updatePasswordForm.style.display = 'none';

        await supabaseClient.auth.signOut();

        setTimeout(() => {
          window.location.href = '/login.html';
        }, 3000);

      } catch (error) {
        console.error('Password update error:', error);
        let userMessage = error.message;

        if (error.message.includes("Auth session missing")) {
          userMessage = "Session expired. Please request a new password reset link.";
        }
        else if (error.message.includes("Token has expired")) {
          userMessage = "This recovery link has expired. Please request a new one.";
        }

        showMessage(userMessage, 'error');
        updateBtn.disabled = false;
        updateBtn.textContent = 'Update Password';
      }
    });

    function showMessage(text, type) {
      if (type === 'none') {
        messageDiv.style.display = 'none';
        return;
      }
      messageDiv.textContent = text;
      messageDiv.className = `message ${type}`;
      messageDiv.style.display = 'block';
    }
  </script>
</body>

</html>